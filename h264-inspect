#!/bin/bash
#h264-inspect
#Brief: h264_analyze bash wrapper
#Author: Jose Lopez
#Copyright: RidgeRun LLC 2015

FILE=$1

if [ ! -f /usr/local/bin/h264_analyze ] ; then \
	echo "Error: Could not find file /usr/local/bin/h264_analyze"
	exit 1
fi

echo h264-inspect
echo ------------

#Generate .nalutype file from h264_analyze exercise
if [ ! -f $1.nalutype ] ; then \
  echo "Info: Generating $1.nalutype .."
  h264_analyze $FILE | grep 'nal_unit_type' | sed 's/.*://' | cut -f1 -d"(" &> $1.nalutype
else
  echo "Info: Using existing $1.nalutype"
fi

echo ------------
echo NAL units
echo ------------

nalu_count=`cat $1.nalutype | wc -l`
echo NALU count: $nalu_count

sei_count=`cat $1.nalutype | grep '^ 6 $' | wc -l`
echo SEI count: $sei_count

sps_count=`cat $1.nalutype | grep '^ 7 $' | wc -l`
echo SPS count: $sps_count

pps_count=`cat $1.nalutype | grep '^ 8 $' | wc -l`
echo PPS count: $pps_count

aud_count=`cat $1.nalutype | grep '^ 9 $' | wc -l`
echo AUD count: $aud_count

eoseq_count=`cat $1.nalutype | grep '^ 10 $' | wc -l`
echo EOSEQ count: $eoseq_count

eostream_count=`cat $1.nalutype | grep '^ 11 $' | wc -l`
echo EOSTREAM count: $eostream_count

filler_count=`cat $1.nalutype | grep '^ 12 $' | wc -l`
echo FILLER count: $filler_count

sps_vui_count=`cat $1.nalutype | grep '^ 13 $' | wc -l`
echo SPS+VUI count: $sps_vui_count

usei_count=`cat $1.nalutype | grep '^ 14 $' | wc -l`
echo USEI count: $usei_count

#Generate .slicetype file from h264_analyze exercise
echo ------------
if [ ! -f $1.slicetype ] ; then \
  echo "Info: Generating $1.slicetype .."
  h264_analyze $FILE | grep 'slice_type' | sed 's/.*://' | cut -f1 -d"(" &> $1.slicetype
else
  echo "Info: Using existing $1.slicetype"
fi

echo ------------
echo Slices
echo ------------

pw_count=`cat $1.slicetype | grep '^ 0 $' | wc -l`
echo P* count: $pw_count

p_count=`cat $1.slicetype | grep '^ 5 $' | wc -l`
echo P count: $p_count

bw_count=`cat $1.slicetype | grep '^ 1 $' | wc -l`
echo B* count: $bw_count

b_count=`cat $1.slicetype | grep '^ 6 $' | wc -l`
echo B count: $b_count

iw_count=`cat $1.slicetype | grep '^ 2 $' | wc -l`
echo I* count: $iw_count

i_count=`cat $1.slicetype | grep '^ 7 $' | wc -l`
echo I count: $i_count
echo ------------

#TODO: Use constants
#TODO: Write pattern_count function (or loop+array)
#TODO: Add glossary
